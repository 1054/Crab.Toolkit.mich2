#!/bin/bash
#

# 
# readlink for Mac (because Mac readlink does not accept "-f" option)
# 
if [[ $(uname) == *"Darwin"* ]]; then
    function readlink() {
        if [[ $# -gt 1 ]]; then if [[ "$1" == "-f" ]]; then shift; fi; fi
        DIR="$1"; if [[ "$DIR" != *"/"* ]]; then DIR="./$DIR"; fi # 20170228: fixed bug: path without "/"
        DIR=$(echo "${DIR%/*}") # 20160410: fixed bug: source SETUP just under the Softwares dir
        if [[ -d "$DIR" ]]; then cd "$DIR" && echo "$(pwd -P)/$(basename ${1})"; 
        else echo "$(pwd -P)/$(basename ${1})"; fi
    }
fi



# 
# Main program
# 
deploy_current_dir=$(pwd)
deploy_script_dir=$(readlink -f $(dirname "${BASH_SOURCE[0]}"))
deploy_upper_dir=$(readlink -f $(dirname "${deploy_script_dir}"))

echo "Welcome"
echo "Deploying michi2 into ${deploy_current_dir} ..."
#sleep 0.25

# 
# Type of fitting
# 
deploy_type="SED"
if [[ $# -ge 1 ]]; then
    deploy_type="$1"
fi

# 
# Copy files
# 
if echo "$deploy_type" | grep -q -i "SED"; then
    #cp "${deploy_upper_dir}/data/deploy_michi2"/*.sm "${deploy_upper_dir}/data/deploy_michi2"/run*.sh .
    #cp "${deploy_upper_dir}/data/deploy_SED"/run*.sh .
    #cp "${deploy_upper_dir}/data/deploy_SED"/run*.sm .
    #cp "${deploy_upper_dir}/data/deploy_SED"/pChisq.sm .
    #cp "${deploy_upper_dir}/data/deploy_SED"/rShift.sm .
    #cp "${deploy_upper_dir}/data/deploy_SED"/rUmean.sm .
    #cp "${deploy_upper_dir}/data/deploy_SED"/rChisq.sm .
    cp -r "${deploy_upper_dir}/data/deploy_SED"/filters .
    cp -r "${deploy_upper_dir}/data/deploy_SED"/filter.list .
    # 
    if [[ $(echo "$@" | sed -e 's/-/ /g' | tr -s ' ' | grep -i "FSPS SSP" | wc -l) -eq 1 ]]; then
        unzip -o "${deploy_upper_dir}/data/lib_SED/FSPS.Padova.BaSeL.Z0.0190.EBV.lib.zip"
    elif [[ $(echo "$@" | sed -e 's/-/ /g' | tr -s ' ' | grep -i "FSPS" | wc -l) -eq 1 ]]; then
        unzip -o "${deploy_upper_dir}/data/lib_SED/lib.FSPS.CSP.tau.1Gyr.Padova.BaSeL.Z0.0190.EBV.SED.zip"
    elif [[ $(echo "$@" | sed -e 's/-/ /g' | tr -s ' ' | grep -i "no stellar" | wc -l) -eq 0 ]]; then
        unzip -o "${deploy_upper_dir}/data/lib_SED/lib.BC03.Padova1994.BaSeL.Z0.0190.EBV.SED.zip"
    fi
    # 
    if [[ $(echo "$@" | sed -e 's/-/ /g' | tr -s ' ' | grep -i "single qPAH" | wc -l) -eq 1 ]]; then
        unzip -o "${deploy_upper_dir}/data/lib_SED/DL07.DuoCom.SinglePAH.lib.zip"
    elif [[ $(echo "$@" | sed -e 's/-/ /g' | tr -s ' ' | grep -i "no dust" | wc -l) -eq 0 ]]; then
        unzip -o "${deploy_upper_dir}/data/lib_SED/lib.DL07.DuoCom.SED.zip"
    fi
    # 
    if [[ $(echo "$@" | sed -e 's/-/ /g' | tr -s ' ' | grep -i "Siebenmorgen" | wc -l) -eq 1 ]]; then
        unzip -o "${deploy_upper_dir}/data/lib_SED/lib.SiebenmorgenAGN.Extrapolated.SED.zip"
    elif [[ $(echo "$@" | sed -e 's/-/ /g' | tr -s ' ' | grep -i "no AGN" | wc -l) -eq 0 ]]; then
        unzip -o "${deploy_upper_dir}/data/lib_SED/lib.MullaneyAGN.SED.zip"
    fi
    # 
    if [[ $(echo "$@" | sed -e 's/-/ /g' | tr -s ' ' | grep -i "no radio" | wc -l) -eq 0 ]]; then
        unzip -o "${deploy_upper_dir}/data/lib_SED/RadioPowerlaw.Single.lib.SED.zip"
    fi
    # 
    #echo "#!/bin/bash" > "run_fitting_5_components.sh"
    #echo "#" >> "run_fitting_5_components.sh"
    #echo "$(dirname ${BASH_SOURCE[0]})/michi2-run-fitting-5-components \$@" >> "run_fitting_5_components.sh"
    #chmod +x "run_fitting_5_components.sh"
    # 
    #echo "#!/bin/bash" > "run_plotting_5_components.sh"
    #echo "#" >> "run_plotting_5_components.sh"
    #echo "$(dirname ${BASH_SOURCE[0]})/michi2-plot-results-of-fitting-5-components \$@" >> "run_plotting_5_components.sh"
    #chmod +x "run_plotting_5_components.sh"
    # 
elif echo "$deploy_type" | grep -q -i "LVG"; then
    cp "${deploy_upper_dir}/data/deploy_LVG"/*.sm "${deploy_upper_dir}/data/deploy_LVG"/run*.sh .
    cp "${deploy_upper_dir}/data/lib_LVG/"lib_*.lvg .
fi
#if [[ $(uname) == "Darwin" ]]; then
#    echo "Mac!"; sleep 1.0
#    #cp "${deploy_upper_dir}/bin/michi2_v03_20160727mac" .
#    #ln -fs "michi2_v03_20160727mac" michi2_v03
#    #cp "${deploy_upper_dir}/bin/michi2_v04_20171002_0621_mac" .
#    #ln -fs "michi2_v04_20171002_0621_mac" michi2_v04
#    #cp "${deploy_upper_dir}/bin/michi2_v04_20180110_mac" .
#    #ln -fs "michi2_v04_20180110_mac" michi2_v04
#    cp "${deploy_upper_dir}/bin/michi2_v04_20180111_mac" .
#    ln -fs "michi2_v04_20180111_mac" michi2_v04
#    chmod +x michi2_v04
#else
#    cp "${deploy_upper_dir}/bin/michi2_v04_20180110_linux_x86_64" .
#    ln -fs "michi2_v04_20180110_linux_x86_64" michi2_v04
#    chmod +x michi2_v04
#fi

#ln -fs "run_plotting_quintuple.sm" "run_plotting.sm"


